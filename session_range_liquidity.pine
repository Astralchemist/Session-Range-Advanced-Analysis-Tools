//@version=5
indicator("SMC & Liquidity Hunter - Advanced Analysis", overlay=true, max_boxes_count=200, max_lines_count=500, max_labels_count=150)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// Session Settings
sessionStartHour = input.int(7, "Session Start Hour", minval=0, maxval=23, group="Session")
sessionStartMinute = input.int(30, "Session Start Minute", minval=0, maxval=59, group="Session")
sessionEndHour = input.int(10, "Session End Hour", minval=0, maxval=23, group="Session")
sessionEndMinute = input.int(0, "Session End Minute", minval=0, maxval=59, group="Session")
showLabels = input(true, "Show Labels", group="Session")

// SMART MONEY CONCEPTS
show_bos = input.bool(true, "Show BOS (Break of Structure)", group="SMC")
show_choch = input.bool(true, "Show ChoCh (Change of Character)", group="SMC")
show_market_structure = input.bool(true, "Show Market Structure", group="SMC")
structure_lookback = input.int(10, "Structure Lookback", minval=5, maxval=50, group="SMC")

// Equal Highs/Lows (Liquidity Pools)
show_equal_levels = input.bool(true, "Show Equal Highs/Lows", group="Equal Levels")
equal_level_tolerance = input.float(0.2, "Equal Level Tolerance %", minval=0.05, maxval=1.0, step=0.05, group="Equal Levels")
min_equal_touches = input.int(2, "Min Equal Touches", minval=2, maxval=5, group="Equal Levels")

// Fair Value Gaps
show_fvg = input.bool(true, "Show FVG", group="Fair Value Gaps")
show_ifvg = input.bool(true, "Show Inverse FVG", group="Fair Value Gaps")
fvg_min_size = input.float(0.3, "Min FVG Size (ATR Multiple)", minval=0.1, maxval=2.0, step=0.1, group="Fair Value Gaps")
auto_invalidate_fvg = input.bool(true, "Auto Invalidate Filled FVG", group="Fair Value Gaps")

// Order Blocks
show_order_blocks = input.bool(true, "Show Order Blocks", group="Order Blocks")
ob_lookback = input.int(10, "Order Block Lookback", minval=3, maxval=30, group="Order Blocks")
show_breaker_blocks = input.bool(true, "Show Breaker Blocks", group="Order Blocks")

// Liquidity Analysis
show_liquidity_zones = input.bool(true, "Show Liquidity Zones", group="Liquidity")
show_liquidity_sweeps = input.bool(true, "Show Liquidity Sweeps", group="Liquidity")
show_stop_hunts = input.bool(true, "Show Stop Hunts", group="Liquidity")
show_fake_breakouts = input.bool(true, "Show Fake Breakouts", group="Liquidity")
liquidity_lookback = input.int(20, "Liquidity Lookback", minval=10, maxval=100, group="Liquidity")

// Premium/Discount Zones
show_premium_discount = input.bool(true, "Show Premium/Discount Zones", group="Premium/Discount")
show_equilibrium = input.bool(true, "Show Equilibrium", group="Premium/Discount")

// Higher Timeframe Analysis
enable_htf = input.bool(true, "Enable HTF Analysis", group="HTF Analysis")
htf_timeframe = input.timeframe("240", "Higher Timeframe", group="HTF Analysis")
htf_structure_timeframe = input.timeframe("D", "HTF Structure Timeframe", group="HTF Analysis")

// Direction Prediction
show_bias = input.bool(true, "Show Directional Bias", group="Bias Prediction")
bias_strength_threshold = input.int(60, "Min Bias Strength", minval=0, maxval=100, group="Bias Prediction")

// Confluence Settings
min_confluence_score = input.int(50, "Minimum Confluence Score", minval=0, maxval=100, group="Confluence")
show_confluence_only = input.bool(false, "Show High Confluence Signals Only", group="Confluence")

// ATR & Volume
atr_length = input.int(14, "ATR Length", minval=1, group="Technical")
min_volume_multiplier = input.float(1.2, "Min Volume Multiplier", minval=1.0, maxval=3.0, step=0.1, group="Technical")

// Risk Management
show_risk_levels = input.bool(true, "Show Risk Levels", group="Risk Management")
risk_reward_ratio = input.float(3.0, "Risk/Reward Ratio", minval=1.0, maxval=10.0, step=0.5, group="Risk Management")
atr_stop_multiplier = input.float(1.5, "ATR Stop Multiplier", minval=0.5, maxval=5.0, step=0.1, group="Risk Management")

// ============================================================================
// INPUT VALIDATION
// ============================================================================

sessionStart = sessionStartHour * 60 + sessionStartMinute
sessionEnd = sessionEndHour * 60 + sessionEndMinute
if sessionStart >= sessionEnd
    runtime.error("Session start must be before session end")

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

// Check if two prices are approximately equal (within tolerance)
isEqual(price1, price2, tolerance_pct) =>
    math.abs(price1 - price2) / price1 * 100 < tolerance_pct

// Check if price is near level
isNear(price1, price2, atr_val) =>
    math.abs(price1 - price2) < atr_val * 0.5

// Check if in premium zone (upper 50% of range)
inPremium(price, range_high, range_low) =>
    equilibrium_level = (range_high + range_low) / 2
    price > equilibrium_level

// Check if in discount zone (lower 50% of range)
inDiscount(price, range_high, range_low) =>
    equilibrium_level = (range_high + range_low) / 2
    price < equilibrium_level

// ============================================================================
// COLORS & STYLES
// ============================================================================

color_bos_bullish = color.new(color.green, 0)
color_bos_bearish = color.new(color.red, 0)
color_choch_bullish = color.new(color.aqua, 0)
color_choch_bearish = color.new(color.orange, 0)
color_fvg_bullish = color.new(#089981, 85)
color_fvg_bearish = color.new(#F23645, 85)
color_ifvg_bullish = color.new(color.blue, 88)
color_ifvg_bearish = color.new(color.purple, 88)
color_ob_bullish = color.new(color.green, 80)
color_ob_bearish = color.new(color.red, 80)
color_liquidity = color.new(color.yellow, 60)
color_premium = color.new(color.red, 95)
color_discount = color.new(color.green, 95)
color_equilibrium = color.new(color.gray, 70)

// ============================================================================
// SESSION TRACKING
// ============================================================================

currentTimeMinutes = hour * 60 + minute
isInSession = currentTimeMinutes >= sessionStart and currentTimeMinutes <= sessionEnd

var float sessionHigh = float(na)
var float sessionLow = float(na)
var int sessionStartBar = na
var int sessionEndBar = na
var bool newSession = false

sessionJustStarted = not isInSession[1] and isInSession
sessionJustEnded = isInSession[1] and not isInSession

if sessionJustStarted
    sessionHigh := high
    sessionLow := low
    sessionStartBar := bar_index
    newSession := true
else
    newSession := false

if isInSession
    if high > sessionHigh
        sessionHigh := high
    if low < sessionLow
        sessionLow := low

if sessionJustEnded
    sessionEndBar := bar_index - 1

// ============================================================================
// ATR & VOLUME
// ============================================================================

atr = ta.atr(atr_length)
avg_volume = ta.sma(volume, 20)
high_volume = volume > avg_volume * min_volume_multiplier

// ============================================================================
// MARKET STRUCTURE - BOS & ChoCh DETECTION
// ============================================================================

// Track swing highs and lows for structure
var float[] swing_highs = array.new_float()
var float[] swing_lows = array.new_float()
var int[] swing_high_bars = array.new_int()
var int[] swing_low_bars = array.new_int()

// Detect swing points
swing_high = ta.pivothigh(high, structure_lookback, structure_lookback)
swing_low = ta.pivotlow(low, structure_lookback, structure_lookback)

// Store swing points
if not na(swing_high)
    if array.size(swing_highs) >= 20
        array.shift(swing_highs)
        array.shift(swing_high_bars)
    array.push(swing_highs, swing_high)
    array.push(swing_high_bars, bar_index - structure_lookback)

if not na(swing_low)
    if array.size(swing_lows) >= 20
        array.shift(swing_lows)
        array.shift(swing_low_bars)
    array.push(swing_lows, swing_low)
    array.push(swing_low_bars, bar_index - structure_lookback)

// Market Structure State
var string market_structure = "RANGING"  // BULLISH, BEARISH, RANGING
var float last_structure_high = float(na)
var float last_structure_low = float(na)
var int last_bos_bar = na
var int last_choch_bar = na

// BOS and ChoCh detection
bos_bullish = false
bos_bearish = false
choch_bullish = false
choch_bearish = false

// Get previous swing points
if array.size(swing_highs) >= 2 and array.size(swing_lows) >= 2
    prev_high = array.get(swing_highs, array.size(swing_highs) - 2)
    curr_high = array.get(swing_highs, array.size(swing_highs) - 1)
    prev_low = array.get(swing_lows, array.size(swing_lows) - 2)
    curr_low = array.get(swing_lows, array.size(swing_lows) - 1)

    // BOS Bullish: In uptrend, break previous high
    if market_structure == "BULLISH" or market_structure == "RANGING"
        if close > prev_high and high_volume
            bos_bullish := true
            market_structure := "BULLISH"
            last_structure_high := close
            last_bos_bar := bar_index

    // BOS Bearish: In downtrend, break previous low
    if market_structure == "BEARISH" or market_structure == "RANGING"
        if close < prev_low and high_volume
            bos_bearish := true
            market_structure := "BEARISH"
            last_structure_low := close
            last_bos_bar := bar_index

    // ChoCh Bullish: In downtrend, break previous high (trend change)
    if market_structure == "BEARISH"
        if close > prev_high
            choch_bullish := true
            market_structure := "BULLISH"
            last_choch_bar := bar_index

    // ChoCh Bearish: In uptrend, break previous low (trend change)
    if market_structure == "BULLISH"
        if close < prev_low
            choch_bearish := true
            market_structure := "BEARISH"
            last_choch_bar := bar_index

// Plot BOS and ChoCh
plotshape(show_bos and bos_bullish, "BOS↑", shape.triangleup, location.belowbar, color_bos_bullish, size=size.small, text="BOS")
plotshape(show_bos and bos_bearish, "BOS↓", shape.triangledown, location.abovebar, color_bos_bearish, size=size.small, text="BOS")
plotshape(show_choch and choch_bullish, "ChoCh↑", shape.circle, location.belowbar, color_choch_bullish, size=size.normal, text="ChoCh")
plotshape(show_choch and choch_bearish, "ChoCh↓", shape.circle, location.abovebar, color_choch_bearish, size=size.normal, text="ChoCh")

// ============================================================================
// EQUAL HIGHS & EQUAL LOWS (Liquidity Pools)
// ============================================================================

var line[] equal_high_lines = array.new_line()
var line[] equal_low_lines = array.new_line()
var label[] equal_labels = array.new_label()

// Detect equal highs (liquidity pools)
if show_equal_levels and array.size(swing_highs) >= min_equal_touches
    for i = array.size(swing_highs) - 1 to math.max(0, array.size(swing_highs) - 10)
        equal_count = 1
        base_high = array.get(swing_highs, i)

        for j = i - 1 to math.max(0, i - 5)
            if j >= 0
                compare_high = array.get(swing_highs, j)
                if isEqual(base_high, compare_high, equal_level_tolerance)
                    equal_count += 1

        if equal_count >= min_equal_touches
            // Found equal highs - draw liquidity line
            if array.size(equal_high_lines) >= 30
                old_line = array.shift(equal_high_lines)
                line.delete(old_line)

            new_line = line.new(bar_index - 20, base_high, bar_index + 10, base_high,
                               color=color_liquidity, style=line.style_dashed, width=2)
            array.push(equal_high_lines, new_line)

            if showLabels and array.size(equal_labels) < 20
                lbl = label.new(bar_index, base_high, "EQH " + str.tostring(equal_count) + "x",
                               style=label.style_label_down, color=color_liquidity, textcolor=color.black, size=size.small)
                array.push(equal_labels, lbl)
            break

// Detect equal lows (liquidity pools)
if show_equal_levels and array.size(swing_lows) >= min_equal_touches
    for i = array.size(swing_lows) - 1 to math.max(0, array.size(swing_lows) - 10)
        equal_count = 1
        base_low = array.get(swing_lows, i)

        for j = i - 1 to math.max(0, i - 5)
            if j >= 0
                compare_low = array.get(swing_lows, j)
                if isEqual(base_low, compare_low, equal_level_tolerance)
                    equal_count += 1

        if equal_count >= min_equal_touches
            // Found equal lows - draw liquidity line
            if array.size(equal_low_lines) >= 30
                old_line = array.shift(equal_low_lines)
                line.delete(old_line)

            new_line = line.new(bar_index - 20, base_low, bar_index + 10, base_low,
                               color=color_liquidity, style=line.style_dashed, width=2)
            array.push(equal_low_lines, new_line)

            if showLabels and array.size(equal_labels) < 20
                lbl = label.new(bar_index, base_low, "EQL " + str.tostring(equal_count) + "x",
                               style=label.style_label_up, color=color_liquidity, textcolor=color.black, size=size.small)
                array.push(equal_labels, lbl)
            break

// ============================================================================
// LIQUIDITY SWEEPS & STOP HUNTS
// ============================================================================

var float[] liquidity_highs = array.new_float()
var float[] liquidity_lows = array.new_float()

// Store recent swing points as liquidity targets
if not na(swing_high)
    if array.size(liquidity_highs) >= 15
        array.shift(liquidity_highs)
    array.push(liquidity_highs, swing_high)

if not na(swing_low)
    if array.size(liquidity_lows) >= 15
        array.shift(liquidity_lows)
    array.push(liquidity_lows, swing_low)

// Detect liquidity sweeps and stop hunts
liquidity_sweep_high = false
liquidity_sweep_low = false
stop_hunt_high = false
stop_hunt_low = false
fake_breakout_high = false
fake_breakout_low = false

// Sweep detection with reversal confirmation
if array.size(liquidity_highs) > 0
    for i = 0 to math.min(4, array.size(liquidity_highs) - 1)
        liq_high = array.get(liquidity_highs, array.size(liquidity_highs) - 1 - i)

        // Liquidity sweep: Wick above, close back below
        if high > liq_high and close < liq_high
            liquidity_sweep_high := true

            // Stop hunt: Also has high volume (institutional)
            if high_volume
                stop_hunt_high := true

            // Fake breakout: Close significantly below after breaking
            if close < liq_high - atr * 0.5
                fake_breakout_high := true
            break

if array.size(liquidity_lows) > 0
    for i = 0 to math.min(4, array.size(liquidity_lows) - 1)
        liq_low = array.get(liquidity_lows, array.size(liquidity_lows) - 1 - i)

        // Liquidity sweep: Wick below, close back above
        if low < liq_low and close > liq_low
            liquidity_sweep_low := true

            // Stop hunt: Also has high volume (institutional)
            if high_volume
                stop_hunt_low := true

            // Fake breakout: Close significantly above after breaking
            if close > liq_low + atr * 0.5
                fake_breakout_low := true
            break

// Plot liquidity events
plotshape(show_liquidity_sweeps and liquidity_sweep_high, "Liq Sweep↓", shape.xcross, location.abovebar, color.new(color.yellow, 0), size=size.tiny, text="LS")
plotshape(show_liquidity_sweeps and liquidity_sweep_low, "Liq Sweep↑", shape.xcross, location.belowbar, color.new(color.yellow, 0), size=size.tiny, text="LS")
plotshape(show_stop_hunts and stop_hunt_high, "Stop Hunt↓", shape.diamond, location.abovebar, color.new(color.orange, 0), size=size.small, text="SH")
plotshape(show_stop_hunts and stop_hunt_low, "Stop Hunt↑", shape.diamond, location.belowbar, color.new(color.lime, 0), size=size.small, text="SH")
plotshape(show_fake_breakouts and fake_breakout_high, "Fake BO↓", shape.square, location.abovebar, color.new(color.fuchsia, 0), size=size.small, text="FBO")
plotshape(show_fake_breakouts and fake_breakout_low, "Fake BO↑", shape.square, location.belowbar, color.new(color.aqua, 0), size=size.small, text="FBO")

// ============================================================================
// FAIR VALUE GAPS (FVG) & INVERSE FVG
// ============================================================================

var box[] bullish_fvg_boxes = array.new_box()
var box[] bearish_fvg_boxes = array.new_box()
var box[] bullish_ifvg_boxes = array.new_box()
var box[] bearish_ifvg_boxes = array.new_box()

// FVG: Price leaves an imbalance/gap
// Bullish FVG: Gap between high[2] and low (current bar), with bullish momentum
bullish_fvg = show_fvg and low > high[2] and close[1] > open[1] and (low - high[2]) > (atr * fvg_min_size)

// Bearish FVG: Gap between low[2] and high (current bar), with bearish momentum
bearish_fvg = show_fvg and high < low[2] and close[1] < open[1] and (low[2] - high) > (atr * fvg_min_size)

// INVERSE FVG: Overlapping candles (no gap, extreme overlap)
// Bullish IFVG: Price consolidating in tight range before bullish move
bullish_ifvg = show_ifvg and high < high[1] and low > low[1] and close > open and high_volume

// Bearish IFVG: Price consolidating in tight range before bearish move
bearish_ifvg = show_ifvg and high < high[1] and low > low[1] and close < open and high_volume

// Draw FVG boxes
if bullish_fvg
    if array.size(bullish_fvg_boxes) >= 40
        old_box = array.shift(bullish_fvg_boxes)
        box.delete(old_box)

    new_box = box.new(bar_index - 2, high[2], bar_index + 20, low,
                     border_color=color_fvg_bullish,
                     bgcolor=color_fvg_bullish,
                     extend=extend.right)
    array.push(bullish_fvg_boxes, new_box)

if bearish_fvg
    if array.size(bearish_fvg_boxes) >= 40
        old_box = array.shift(bearish_fvg_boxes)
        box.delete(old_box)

    new_box = box.new(bar_index - 2, high, bar_index + 20, low[2],
                     border_color=color_fvg_bearish,
                     bgcolor=color_fvg_bearish,
                     extend=extend.right)
    array.push(bearish_fvg_boxes, new_box)

// Draw IFVG boxes (inverse - consolidation zones)
if bullish_ifvg
    if array.size(bullish_ifvg_boxes) >= 20
        old_box = array.shift(bullish_ifvg_boxes)
        box.delete(old_box)

    new_box = box.new(bar_index - 1, high[1], bar_index + 15, low[1],
                     border_color=color_ifvg_bullish,
                     bgcolor=color_ifvg_bullish,
                     extend=extend.right)
    array.push(bullish_ifvg_boxes, new_box)

if bearish_ifvg
    if array.size(bearish_ifvg_boxes) >= 20
        old_box = array.shift(bearish_ifvg_boxes)
        box.delete(old_box)

    new_box = box.new(bar_index - 1, high[1], bar_index + 15, low[1],
                     border_color=color_ifvg_bearish,
                     bgcolor=color_ifvg_bearish,
                     extend=extend.right)
    array.push(bearish_ifvg_boxes, new_box)

// Auto-invalidate filled FVGs
if auto_invalidate_fvg
    // Check bullish FVGs for fills
    if array.size(bullish_fvg_boxes) > 0
        for i = array.size(bullish_fvg_boxes) - 1 to 0
            fvg_box = array.get(bullish_fvg_boxes, i)
            fvg_top = box.get_top(fvg_box)
            fvg_bottom = box.get_bottom(fvg_box)

            // If price filled the FVG, delete it
            if low <= fvg_bottom
                box.delete(fvg_box)
                array.remove(bullish_fvg_boxes, i)

    // Check bearish FVGs for fills
    if array.size(bearish_fvg_boxes) > 0
        for i = array.size(bearish_fvg_boxes) - 1 to 0
            fvg_box = array.get(bearish_fvg_boxes, i)
            fvg_top = box.get_top(fvg_box)
            fvg_bottom = box.get_bottom(fvg_box)

            // If price filled the FVG, delete it
            if high >= fvg_top
                box.delete(fvg_box)
                array.remove(bearish_fvg_boxes, i)

// ============================================================================
// ORDER BLOCKS & BREAKER BLOCKS
// ============================================================================

var box[] bullish_ob_boxes = array.new_box()
var box[] bearish_ob_boxes = array.new_box()
var box[] breaker_boxes = array.new_box()

if show_order_blocks
    // Bullish Order Block: Last bearish candle before strong bullish move
    strong_bull_move = close > high[3] and volume > avg_volume * 1.3 and close > open
    if strong_bull_move
        for i = 1 to ob_lookback
            if close[i] < open[i]  // Found bearish candle
                if array.size(bullish_ob_boxes) >= 30
                    old_box = array.shift(bullish_ob_boxes)
                    box.delete(old_box)

                new_box = box.new(bar_index - i, high[i], bar_index + 25, low[i],
                                 border_color=color_ob_bullish,
                                 bgcolor=color_ob_bullish,
                                 extend=extend.right)
                array.push(bullish_ob_boxes, new_box)
                break

    // Bearish Order Block: Last bullish candle before strong bearish move
    strong_bear_move = close < low[3] and volume > avg_volume * 1.3 and close < open
    if strong_bear_move
        for i = 1 to ob_lookback
            if close[i] > open[i]  // Found bullish candle
                if array.size(bearish_ob_boxes) >= 30
                    old_box = array.shift(bearish_ob_boxes)
                    box.delete(old_box)

                new_box = box.new(bar_index - i, high[i], bar_index + 25, low[i],
                                 border_color=color_ob_bearish,
                                 bgcolor=color_ob_bearish,
                                 extend=extend.right)
                array.push(bearish_ob_boxes, new_box)
                break

// Breaker Blocks: OB that failed and reversed (strong reversal signal)
breaker_bullish = false
breaker_bearish = false

if show_breaker_blocks
    // Check if bearish OB was broken (becomes bullish breaker)
    if array.size(bearish_ob_boxes) > 0
        for i = array.size(bearish_ob_boxes) - 1 to math.max(0, array.size(bearish_ob_boxes) - 5)
            ob_box = array.get(bearish_ob_boxes, i)
            ob_top = box.get_top(ob_box)

            if close > ob_top and high_volume
                breaker_bullish := true
                // Convert to breaker
                if array.size(breaker_boxes) < 20
                    breaker_box = box.new(box.get_left(ob_box), box.get_top(ob_box), bar_index + 20, box.get_bottom(ob_box),
                                         border_color=color.new(color.lime, 70),
                                         bgcolor=color.new(color.lime, 85))
                    array.push(breaker_boxes, breaker_box)
                box.delete(ob_box)
                array.remove(bearish_ob_boxes, i)
                break

plotshape(show_breaker_blocks and breaker_bullish, "Breaker↑", shape.star, location.belowbar, color.new(color.lime, 0), size=size.small, text="BB")
plotshape(show_breaker_blocks and breaker_bearish, "Breaker↓", shape.star, location.abovebar, color.new(color.fuchsia, 0), size=size.small, text="BB")

// ============================================================================
// PREMIUM/DISCOUNT ZONES
// ============================================================================

// Calculate current range (session or swing range)
range_high = not na(sessionHigh) ? sessionHigh : ta.highest(high, 50)
range_low = not na(sessionLow) ? sessionLow : ta.lowest(low, 50)
equilibrium = (range_high + range_low) / 2

in_premium = close > equilibrium
in_discount = close < equilibrium
at_equilibrium = math.abs(close - equilibrium) < atr * 0.3

// Plot premium/discount zones
bgcolor(show_premium_discount and in_premium ? color_premium : na, title="Premium Zone")
bgcolor(show_premium_discount and in_discount ? color_discount : na, title="Discount Zone")
plot(show_equilibrium ? equilibrium : na, "Equilibrium", color=color_equilibrium, linewidth=2, style=plot.style_cross)

// ============================================================================
// HIGHER TIMEFRAME ANALYSIS
// ============================================================================

htf_close = request.security(syminfo.tickerid, htf_timeframe, close, lookahead=barmerge.lookahead_off)
htf_high = request.security(syminfo.tickerid, htf_timeframe, high, lookahead=barmerge.lookahead_off)
htf_low = request.security(syminfo.tickerid, htf_timeframe, low, lookahead=barmerge.lookahead_off)
htf_trend_up = htf_close > htf_close[1]
htf_trend_down = htf_close < htf_close[1]

// HTF structure
htf_structure = request.security(syminfo.tickerid, htf_structure_timeframe, market_structure, lookahead=barmerge.lookahead_off)
htf_bullish_structure = htf_structure == "BULLISH"
htf_bearish_structure = htf_structure == "BEARISH"

// ============================================================================
// DIRECTIONAL BIAS PREDICTION
// ============================================================================

// Calculate bias score based on SMC concepts
bullish_bias_score = 0
bearish_bias_score = 0

// Market Structure (30 points)
if market_structure == "BULLISH"
    bullish_bias_score += 30
else if market_structure == "BEARISH"
    bearish_bias_score += 30

// Recent BOS/ChoCh (25 points)
if not na(last_bos_bar) and bar_index - last_bos_bar < 10
    if bos_bullish or choch_bullish
        bullish_bias_score += 25
    else if bos_bearish or choch_bearish
        bearish_bias_score += 25

// Liquidity Sweeps (20 points) - Counter-intuitive: sweep low = bullish
if liquidity_sweep_low or stop_hunt_low or fake_breakout_low
    bullish_bias_score += 20
if liquidity_sweep_high or stop_hunt_high or fake_breakout_high
    bearish_bias_score += 20

// Premium/Discount (15 points)
if in_discount
    bullish_bias_score += 15
if in_premium
    bearish_bias_score += 15

// FVG presence (10 points)
if bullish_fvg or bullish_ifvg
    bullish_bias_score += 10
if bearish_fvg or bearish_ifvg
    bearish_bias_score += 10

// HTF alignment (20 points)
if enable_htf
    if htf_bullish_structure
        bullish_bias_score += 20
    if htf_bearish_structure
        bearish_bias_score += 20

// Volume confirmation (10 points)
if high_volume
    if close > open
        bullish_bias_score += 10
    else
        bearish_bias_score += 10

// Order Blocks (15 points)
if show_order_blocks
    if array.size(bullish_ob_boxes) > 0 and close <= box.get_top(array.get(bullish_ob_boxes, array.size(bullish_ob_boxes) - 1))
        bullish_bias_score += 15
    if array.size(bearish_ob_boxes) > 0 and close >= box.get_bottom(array.get(bearish_ob_boxes, array.size(bearish_ob_boxes) - 1))
        bearish_bias_score += 15

// Breaker blocks (25 points - strong signal)
if breaker_bullish
    bullish_bias_score += 25
if breaker_bearish
    bearish_bias_score += 25

// Determine bias
bullish_bias = bullish_bias_score >= bias_strength_threshold
bearish_bias = bearish_bias_score >= bias_strength_threshold

// Bias strength levels
bias_strength_text = ""
bias_color = color.gray

if bullish_bias
    if bullish_bias_score >= 90
        bias_strength_text := "STRONG BULLISH"
        bias_color := color.new(color.lime, 0)
    else if bullish_bias_score >= 70
        bias_strength_text := "BULLISH"
        bias_color := color.new(color.green, 0)
    else
        bias_strength_text := "WEAK BULLISH"
        bias_color := color.new(color.green, 40)
else if bearish_bias
    if bearish_bias_score >= 90
        bias_strength_text := "STRONG BEARISH"
        bias_color := color.new(color.fuchsia, 0)
    else if bearish_bias_score >= 70
        bias_strength_text := "BEARISH"
        bias_color := color.new(color.red, 0)
    else
        bias_strength_text := "WEAK BEARISH"
        bias_color := color.new(color.red, 40)
else
    bias_strength_text := "NEUTRAL"
    bias_color := color.gray

// Plot bias signals
bgcolor(show_bias and enable_htf ? (htf_bullish_structure ? color.new(color.green, 95) : htf_bearish_structure ? color.new(color.red, 95) : na) : na, title="HTF Bias")

// ============================================================================
// CONFLUENCE SIGNALS
// ============================================================================

// High confluence setups combining multiple SMC factors
confluence_long = false
confluence_short = false
confluence_score_long = 0
confluence_score_short = 0

// Long confluence factors
if in_discount
    confluence_score_long += 15
if stop_hunt_low or liquidity_sweep_low
    confluence_score_long += 20
if bullish_fvg or bullish_ifvg
    confluence_score_long += 15
if array.size(bullish_ob_boxes) > 0
    confluence_score_long += 15
if bos_bullish or choch_bullish
    confluence_score_long += 20
if market_structure == "BULLISH"
    confluence_score_long += 10
if high_volume and close > open
    confluence_score_long += 10
if enable_htf and htf_bullish_structure
    confluence_score_long += 15
if breaker_bullish
    confluence_score_long += 25
if fake_breakout_low
    confluence_score_long += 20

// Short confluence factors
if in_premium
    confluence_score_short += 15
if stop_hunt_high or liquidity_sweep_high
    confluence_score_short += 20
if bearish_fvg or bearish_ifvg
    confluence_score_short += 15
if array.size(bearish_ob_boxes) > 0
    confluence_score_short += 15
if bos_bearish or choch_bearish
    confluence_score_short += 20
if market_structure == "BEARISH"
    confluence_score_short += 10
if high_volume and close < open
    confluence_score_short += 10
if enable_htf and htf_bearish_structure
    confluence_score_short += 15
if breaker_bearish
    confluence_score_short += 25
if fake_breakout_high
    confluence_score_short += 20

// Generate confluence signals
confluence_long := confluence_score_long >= min_confluence_score
confluence_short := confluence_score_short >= min_confluence_score

// Color by score strength
long_color = confluence_score_long >= 90 ? color.new(color.lime, 0) : confluence_score_long >= 70 ? color.new(color.green, 0) : color.new(color.green, 40)
short_color = confluence_score_short >= 90 ? color.new(color.fuchsia, 0) : confluence_score_short >= 70 ? color.new(color.red, 0) : color.new(color.red, 40)

plotshape(confluence_long, "LONG Setup", shape.labelup, location.belowbar, long_color, size=size.normal, text="LONG")
plotshape(confluence_short, "SHORT Setup", shape.labeldown, location.abovebar, short_color, size=size.normal, text="SHORT")

// ============================================================================
// RISK MANAGEMENT
// ============================================================================

atr_stop = atr * atr_stop_multiplier

// For long setups
long_stop_loss = close - atr_stop
long_take_profit = close + (atr_stop * risk_reward_ratio)

// For short setups
short_stop_loss = close + atr_stop
short_take_profit = close - (atr_stop * risk_reward_ratio)

// Plot risk levels
var line long_sl_line = na
var line long_tp_line = na
var line short_sl_line = na
var line short_tp_line = na
var label long_risk_label = na
var label short_risk_label = na

if show_risk_levels and confluence_long
    if not na(long_sl_line)
        line.delete(long_sl_line)
    if not na(long_tp_line)
        line.delete(long_tp_line)
    if not na(long_risk_label)
        label.delete(long_risk_label)

    long_sl_line := line.new(bar_index, long_stop_loss, bar_index + 15, long_stop_loss,
                             color=color.new(color.red, 30), style=line.style_dashed, width=2)
    long_tp_line := line.new(bar_index, long_take_profit, bar_index + 15, long_take_profit,
                             color=color.new(color.green, 30), style=line.style_dashed, width=2)

    risk_text = "LONG\nSL: " + str.tostring(long_stop_loss, format.mintick) + "\nTP: " + str.tostring(long_take_profit, format.mintick) + "\nScore: " + str.tostring(confluence_score_long)
    long_risk_label := label.new(bar_index, long_take_profit, risk_text,
                                 style=label.style_label_down, color=color.green, textcolor=color.white, size=size.normal)

if show_risk_levels and confluence_short
    if not na(short_sl_line)
        line.delete(short_sl_line)
    if not na(short_tp_line)
        line.delete(short_tp_line)
    if not na(short_risk_label)
        label.delete(short_risk_label)

    short_sl_line := line.new(bar_index, short_stop_loss, bar_index + 15, short_stop_loss,
                              color=color.new(color.red, 30), style=line.style_dashed, width=2)
    short_tp_line := line.new(bar_index, short_take_profit, bar_index + 15, short_take_profit,
                              color=color.new(color.green, 30), style=line.style_dashed, width=2)

    risk_text = "SHORT\nSL: " + str.tostring(short_stop_loss, format.mintick) + "\nTP: " + str.tostring(short_take_profit, format.mintick) + "\nScore: " + str.tostring(confluence_score_short)
    short_risk_label := label.new(bar_index, short_take_profit, risk_text,
                                  style=label.style_label_up, color=color.red, textcolor=color.white, size=size.normal)

// ============================================================================
// DASHBOARD
// ============================================================================

var table dashboard = na

if barstate.islast and showLabels
    if na(dashboard)
        dashboard := table.new(position.top_right, 2, 10, bgcolor=color.new(#000000, 20), border_width=2, border_color=color.new(color.gray, 50))

    // Header
    table.cell(dashboard, 0, 0, "SMC ANALYSIS", text_color=color.white, bgcolor=color.new(color.blue, 30), text_size=size.normal)
    table.cell(dashboard, 1, 0, "", bgcolor=color.new(color.blue, 30))

    // Market Structure
    table.cell(dashboard, 0, 1, "Structure", text_color=color.white, bgcolor=color.new(color.gray, 70))
    struct_color = market_structure == "BULLISH" ? color.green : market_structure == "BEARISH" ? color.red : color.gray
    table.cell(dashboard, 1, 1, market_structure, text_color=struct_color, bgcolor=color.new(color.gray, 80), text_size=size.normal)

    // Bias
    table.cell(dashboard, 0, 2, "Bias", text_color=color.white, bgcolor=color.new(color.gray, 70))
    table.cell(dashboard, 1, 2, bias_strength_text, text_color=bias_color, bgcolor=color.new(color.gray, 80))

    // HTF Structure
    table.cell(dashboard, 0, 3, "HTF Structure", text_color=color.white, bgcolor=color.new(color.gray, 70))
    htf_text = htf_bullish_structure ? "BULLISH" : htf_bearish_structure ? "BEARISH" : "NEUTRAL"
    htf_color = htf_bullish_structure ? color.green : htf_bearish_structure ? color.red : color.gray
    table.cell(dashboard, 1, 3, htf_text, text_color=htf_color, bgcolor=color.new(color.gray, 80))

    // Zone
    table.cell(dashboard, 0, 4, "Zone", text_color=color.white, bgcolor=color.new(color.gray, 70))
    zone_text = in_premium ? "PREMIUM" : in_discount ? "DISCOUNT" : "EQUILIBRIUM"
    zone_color = in_premium ? color.red : in_discount ? color.green : color.gray
    table.cell(dashboard, 1, 4, zone_text, text_color=zone_color, bgcolor=color.new(color.gray, 80))

    // Long Score
    table.cell(dashboard, 0, 5, "Long Score", text_color=color.white, bgcolor=color.new(color.green, 60))
    long_score_color = confluence_score_long >= min_confluence_score ? color.lime : color.gray
    table.cell(dashboard, 1, 5, str.tostring(confluence_score_long), text_color=long_score_color, bgcolor=color.new(color.green, 80), text_size=size.large)

    // Short Score
    table.cell(dashboard, 0, 6, "Short Score", text_color=color.white, bgcolor=color.new(color.red, 60))
    short_score_color = confluence_score_short >= min_confluence_score ? color.orange : color.gray
    table.cell(dashboard, 1, 6, str.tostring(confluence_score_short), text_color=short_score_color, bgcolor=color.new(color.red, 80), text_size=size.large)

    // Bullish Bias Score
    table.cell(dashboard, 0, 7, "Bull Bias", text_color=color.white, bgcolor=color.new(color.gray, 70))
    table.cell(dashboard, 1, 7, str.tostring(bullish_bias_score), text_color=color.white, bgcolor=color.new(color.gray, 80))

    // Bearish Bias Score
    table.cell(dashboard, 0, 8, "Bear Bias", text_color=color.white, bgcolor=color.new(color.gray, 70))
    table.cell(dashboard, 1, 8, str.tostring(bearish_bias_score), text_color=color.white, bgcolor=color.new(color.gray, 80))

    // ATR
    table.cell(dashboard, 0, 9, "ATR", text_color=color.white, bgcolor=color.new(color.gray, 70))
    table.cell(dashboard, 1, 9, str.tostring(atr, format.mintick), text_color=color.white, bgcolor=color.new(color.gray, 80))

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(confluence_long, title="Long Confluence Setup", message="HIGH PROBABILITY LONG - Score: " + str.tostring(confluence_score_long))
alertcondition(confluence_short, title="Short Confluence Setup", message="HIGH PROBABILITY SHORT - Score: " + str.tostring(confluence_score_short))
alertcondition(bos_bullish, title="Bullish BOS", message="Break of Structure - Bullish")
alertcondition(bos_bearish, title="Bearish BOS", message="Break of Structure - Bearish")
alertcondition(choch_bullish, title="Bullish ChoCh", message="Change of Character - Bullish")
alertcondition(choch_bearish, title="Bearish ChoCh", message="Change of Character - Bearish")
alertcondition(stop_hunt_low or stop_hunt_high, title="Stop Hunt", message="Stop Hunt Detected")
alertcondition(fake_breakout_low or fake_breakout_high, title="Fake Breakout", message="Fake Breakout Detected")
alertcondition(liquidity_sweep_low or liquidity_sweep_high, title="Liquidity Sweep", message="Liquidity Sweep Detected")
